<!DOCTYPE html>
<html lang=en>
<head>
<script src = "https://cdn.rawgit.com/mrdoob/three.js/r84/build/three.js"></script>
<script src = "https://sdk.altvr.com/libs/altspace.js/2.9.0/altspace.min.js"></script>
<script src = "https://cdnjs.cloudflare.com/ajax/libs/tween.js/16.3.5/Tween.min.js"></script>
<script src = "https://cdn.rawgit.com/NGenesis/altspacevr-behaviors/v1.0.0/js/altspaceutil.min.js"></script>
<script src = "../motion/motion.js"></script>
</head>
<body>
<script>
    var compassURL = "https://cmdrflexo.github.io/AltspaceSDK-Flexo/examples/flexo/scenery_objects/compass/cardinal_01.png"
    var skyDayURL = "https://cmdrflexo.github.io/AltspaceSDK-Flexo/examples/flexo/images/sky/sky_test3.png";
    var skyNightURL = "https://cmdrflexo.github.io/AltspaceSDK-Flexo/examples/flexo/images/sky/galaxy.jpg";
    var moonTextureDir = "https://cmdrflexo.github.io/AltspaceSDK-Flexo/examples/flexo/images/";
    var moonTexturesQuarterRes = [
        moonTextureDir + "moon_quarterRes-A.png",
        moonTextureDir + "moon_quarterRes-B.png",
        moonTextureDir + "moon_quarterRes-C.png",
        moonTextureDir + "moon_quarterRes-D.png",
        moonTextureDir + "moon_quarterRes-E.png",
        moonTextureDir + "moon_quarterRes-F.png",
        moonTextureDir + "moon_quarterRes-G.png",
        moonTextureDir + "moon_quarterRes-H.png"
    ];

    var tiledMoonURL = moonTextureDir + "moon_quarterRes-sheet.png";

    altspaceutil.getFullspaceEnclosure().then(function(enclosure) {

        sim = new altspace.utilities.Simulation();
        
        SetupDebugVisuals();

        var ground = SetupGround();
        var skies = SetupSkies(32, 16);
        var moonPhases = SetupMoonPhases(6, 32, 16);

        function SetupGround() {
            var groundPlane = new THREE.Mesh(
                new THREE.PlaneGeometry(10000, 10000),
                new THREE.MeshBasicMaterial({ color: 0x062116 })
            )
            groundPlane.position.y = -0.1;
            groundPlane.rotation.x = THREE.Math.degToRad(-90);
            sim.scene.add(groundPlane);
            return groundPlane;
        }

        function SetupSkies(longSegs, latSegs) {
            var skyDay = TexturedSphere(1600, longSegs, latSegs, skyDayURL, false);
            skyDay.rotation.z = THREE.Math.degToRad(-45);
            skyDay.scale.x = -1;
            sim.scene.add(skyDay);
            var skyNight = TexturedSphere(1500, longSegs, latSegs, skyNightURL, true);
            skyNight.rotation.x = THREE.Math.degToRad(45);
            skyNight.scale.x = -1;
            skyNight.addBehavior(new SkyRotate(-2000));
            skyNight.addBehavior(new SkyFade(1, 1));
            sim.scene.add(skyNight);
            return {skyDay, skyNight};
        }

        function SetupMoonPhases(radius, longSegs, latSegs) {
            var moons = new Array();
            for(var i = 0; i < moonTexturesQuarterRes.length; i++)
                moons.push(
                    TexturedSphere(
                        radius, 
                        longSegs, 
                        latSegs, 
                        moonTexturesQuarterRes[i], 
                        false
                    )
                );
            for(var m = 0; m < moons.length; m++) {
                moons[m].position.y = -1000;
                sim.scene.add(moons[m]);
            }
            
            var tiledMoonMaterial = new THREE.MeshBasicMaterial({ 
                color: 0xffffff,
                map: new THREE.Texture({ 
                    src: altspaceutil.getAbsoluteURL(tiledMoonURL)
                })
            });
            // tiledMoonMaterial.map.wrapS = tiledMoonMaterial.map.wrapT = THREE.RepeatWrapping;
            
            moons[0].material = tiledMoonMaterial;
            moons[0].material.map.repeat.set(0.5, 0.25);
            moons[0].material.map.offset.set(0.5, 0.5);
            moons[0].material.needsUpdate = true;
            moons[0].geometry.uvsNeedUpdate = true;

            moons[1].material = tiledMoonMaterial.clone();
            moons[1].material.map = tiledMoonMaterial.map.clone();
            moons[1].material.map.repeat.set(0.5, 0.25);
            moons[1].material.map.offset.set(0.5, 0.25);
            moons[1].material.needsUpdate = true;
            moons[1].geometry.uvsNeedUpdate = true;

            moons[0].position.set(1500, 0, 0);
            moons[0].scale.set(3, 3, 3);

            moons[1].position.set(-50, 20, 50);
            moons[1].scale.set(3, 3, 3);

            var moonRoot = new THREE.Object3D();
            moonRoot.add(moons[0]);
            moonRoot.rotation.z = THREE.Math.degToRad(45);
            // moonRoot.addBehavior(new SkyRotate(-2000));
            sim.scene.add(moonRoot);
            

            return moons;
        }
        
        function SetupDebugVisuals() {
            var originReference = new THREE.Mesh(
                new THREE.PlaneGeometry(1, 1),
                new THREE.MeshBasicMaterial({ 
                    color: 0xffffff,
                    map: new THREE.Texture({ 
                        src: altspaceutil.getAbsoluteURL(compassURL)
                    })
                })
            )
            originReference.position.y = 0.1;
            originReference.rotation.x = THREE.Math.degToRad(90);
            originReference.rotation.y = THREE.Math.degToRad(180);
            sim.scene.add(originReference);

            var xPos = new THREE.Mesh(
                new THREE.SphereGeometry(0.1, 16, 8),
                new THREE.MeshBasicMaterial({
                    color : 0xff0000
                })
            );
            xPos.position.y = 0.5;
            xPos.position.x = 1;
            sim.scene.add(xPos);

            var zPos = new THREE.Mesh(
                new THREE.SphereGeometry(0.1, 16, 8),
                new THREE.MeshBasicMaterial({
                    color : 0x0000ff
                })
            );
            zPos.position.y = 0.5;
            zPos.position.z = 1;
            sim.scene.add(zPos);
        }
    });

    function TexturedSphere(radius, longSegs, latSegs, texURL, isTransparent) {
        var skySphere = new THREE.Mesh(
            new THREE.SphereGeometry(radius, longSegs, latSegs),
            new THREE.MeshBasicMaterial({
                color: 0xffffff,
                transparent : isTransparent,
                map: new THREE.Texture({ 
                    src: altspaceutil.getAbsoluteURL(texURL)
                })
            })
        );
        return skySphere;
    }
</script>
</body>
</html>

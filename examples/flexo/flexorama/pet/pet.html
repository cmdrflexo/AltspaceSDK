<!DOCTYPE html>
<html lang=en>
<head>
<!-- <script src = "https://cdn.rawgit.com/mrdoob/three.js/r84/build/three.js"></script> -->
<script src = "https://cdn.rawgit.com/mrdoob/three.js/r94/build/three.js"></script>
<script src = "https://sdk.altvr.com/libs/altspace.js/2.9.0/altspace.min.js"></script>
<script src = "https://cdnjs.cloudflare.com/ajax/libs/tween.js/16.3.5/Tween.min.js"></script>
<script src = "https://cdn.rawgit.com/NGenesis/altspacevr-behaviors/v1.0.0/js/altspaceutil.min.js"></script>
<script src = "../../console/Console.js"></script>
<script src = "PetBehaviors.js"></script>
</head>
<body>
<script>

var ballTextureURL = "https://cmdrflexo.github.io/AltspaceSDK-Flexo/examples/flexo/flexorama/pet/bb.png";
var grassTextureURL = "https://cmdrflexo.github.io/AltspaceSDK-Flexo/examples/flexo/flexorama/textures/16x16_grass.png";

var testing = false;
if(!testing) altspaceutil.getFullspaceEnclosure().then(function(enclosure) { start(); });
else start();

var sim;
var sceneConsole;

function start() {
    sim = new altspace.utilities.Simulation();

    // sceneConsole = SetupConsole(20, 0.6);

    sim.scene.add(CreateTerrain());

    var follower;

    var skeleton;
    var head;
    altspace.getThreeJSTrackingSkeleton().then(function(_skeleton) {
        skeleton = _skeleton;
        sim.scene.add(skeleton);

        head = skeleton.getJoint("Head");

        followerHead = new THREE.Mesh(
            new THREE.SphereGeometry(0.12, 32, 16),
            new THREE.MeshBasicMaterial({
                color: 0x7f7f7f,
                map: new THREE.Texture({ 
                    src: altspaceutil.getAbsoluteURL(ballTextureURL)
                })
            })
        );
        followerHead.position.y = 0.5;
        sim.scene.add(followerHead);
        
        follower = new THREE.Mesh(
            new THREE.SphereGeometry(0.25, 32, 16),
            new THREE.MeshBasicMaterial({
                color: 0x7fff7f,
                map: new THREE.Texture({ 
                    src: altspaceutil.getAbsoluteURL(ballTextureURL)
                })
            })
        );
        follower.position.y = 0.25;
        follower.addBehavior(new Follower(head, 2, 4, 0.25, followerHead));
        sim.scene.add(follower);
    });
}

function SetupConsole(maxLines, spacing) {
    var con = new THREE.Object3D();
    con.addBehavior(new altspaceutil.behaviors.Console({ maxlines: maxLines, passive: false, spacing: spacing }));
    sim.scene.add(con);
    sim.scene.updateAllBehaviors();
    return con;
}

function CreateTerrain() {
    var plane = new THREE.Mesh(
        new THREE.PlaneGeometry(1000, 1000),
        new THREE.MeshBasicMaterial({ 
            color: 0xffffff,
            map: new THREE.Texture({ 
                src: altspaceutil.getAbsoluteURL(grassTextureURL)
            })
        })
    )
    plane.material.map.repeat.set(1000, 1000);
    plane.material.map.wrapS = plane.material.map.wrapT = THREE.RepeatWrapping;
    plane.position.y = -0.01;
    plane.rotation.x = THREE.Math.degToRad(-90);
    return plane;
}

</script>
</body>
</html>

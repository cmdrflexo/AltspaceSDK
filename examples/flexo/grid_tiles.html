<!DOCTYPE html>
<html lang=en>
<head>
	<meta charset=utf-8>
	<title>Grid Tiles</title>
	<script src="https://cdn.rawgit.com/mrdoob/three.js/r84/build/three.min.js"></script>
	<script src="https://cdn.rawgit.com/mrdoob/three.js/r84/examples/js/loaders/MTLLoader.js"></script>
	<script src="https://cdn.rawgit.com/mrdoob/three.js/r84/examples/js/loaders/OBJLoader.js"></script>
    <script src="../../dist/altspace.js"></script>
</head>
<body>
<!-- <a-scene>
    <a-assets>
        <img id='sky' src='images/sky/galaxy.jpg'/>
    </a-assets>
    <a-sky src='#sky' radius='2500'></a-sky>
</a-scene> -->
<script>
	var sim;
	var connection;
    var sceneSync;

    // var model;
    
    var config = { authorId : "Flexo", appId : "grid_tiles"};
    altspace.utilities.sync.connect(config).then(
        function(connection) { start(connection); }
    );

    function start(connection) {
        this.connection = connection;
        sim = new altspace.utilities.Simulation();
        loadModels();
    }

    function loadModels() {
        var loader = new altspace.utilities.shims.OBJMTLLoader();
        var modelsLoaded = 0;
        for(var i = 0; i < models.length; i++) {
            var model;
            loader.load(
                models[i].objURL, models[i].mtlURL,
                (function(obj) {
                    model = obj;
                    modelsLoaded++;
                    modelLoaded(this, model);
                    if(modelsLoaded == models.length) modelsReady();
                    else console.log(modelsLoaded);
                }).bind(i)
            );
        }
    }

    function modelLoaded(i, model) {
        console.log("modelLoaded");
        models[i].model = model;
    }

    function modelsReady() {
        // console.log("modelsReady()");
        // for(var i = 0; i < models.length; i++) {
        //     console.log(models[i].model);
        // }
        sceneSync = new altspace.utilities.behaviors.SceneSync(
            connection.instance,
            {
                instantiators : {"Tile" : createTile},
                ready : ready
            }
        );
        sim.scene.addBehavior(sceneSync);
    }

    // function createTile(index) {
    //     var model = models[index].model.clone();
    //     model.addBehaviors(
	// 		new altspace.utilities.behaviors.Object3DSync(
	// 			{ position : true, rotation : true, scale : true }
	// 		)
	// 	);
	// 	model.position.set(index * 10, 0, 0);
	// 	sim.scene.add(model);
    //     return model;
    // }

    function createTile(info) {
        var model = models[info.index].model.clone();
        model.addBehaviors(
			new altspace.utilities.behaviors.Object3DSync(
				{ position : true, rotation : true, scale : true }
			)
		);
        model.position.set(info.x, 0, info.z);
        model.rotation.set(0, info.rot, 0);
		sim.scene.add(model);
        return model;
    }

    /*

        -1   0   1   2   3   4
     4 [ 0][ 3][ 2][ 2][ 3][ 0]
     3 [ 3][ 4][ 2][ 2][ 4][ 3]
     2 [ 2][ 2][ 1][ 1][ 2][ 2]
     1 [ 2][ 2][ 1][ 1][ 2][ 2]
     0 [ 3]( 4)[ 2][ 2][ 4][ 3]
    -1 [ 0][ 3][ 2][ 2][ 3][ 0]

    sidewalk straight ||[]
    road []|

    */

    function ready() {

        var tile = sceneSync.instantiate("Tile", {index: 0, x :  -10, z :  40, rot : 0});
        var tile = sceneSync.instantiate("Tile", {index: 3, x :    0, z :  40, rot : deg2rad(180)});
        var tile = sceneSync.instantiate("Tile", {index: 2, x :   10, z :  40, rot : 0});
        var tile = sceneSync.instantiate("Tile", {index: 2, x :   20, z :  40, rot : deg2rad(180)});
        var tile = sceneSync.instantiate("Tile", {index: 3, x :   30, z :  40, rot : 0});
        var tile = sceneSync.instantiate("Tile", {index: 0, x :   40, z :  40, rot : 0});

        var tile = sceneSync.instantiate("Tile", {index: 3, x :  -10, z :  30, rot : deg2rad(-90)});
        var tile = sceneSync.instantiate("Tile", {index: 4, x :    0, z :  30, rot : deg2rad(180)});
        var tile = sceneSync.instantiate("Tile", {index: 2, x :   10, z :  30, rot : 0});
        var tile = sceneSync.instantiate("Tile", {index: 2, x :   20, z :  30, rot : deg2rad(180)});
        var tile = sceneSync.instantiate("Tile", {index: 4, x :   30, z :  30, rot : deg2rad(-90)});
        var tile = sceneSync.instantiate("Tile", {index: 3, x :   40, z :  30, rot : deg2rad(-90)});

        var tile = sceneSync.instantiate("Tile", {index: 2, x :  -10, z :  20, rot : deg2rad(90)});
        var tile = sceneSync.instantiate("Tile", {index: 2, x :    0, z :  20, rot : deg2rad(90)});
        var tile = sceneSync.instantiate("Tile", {index: 1, x :   10, z :  20, rot : 0});
        var tile = sceneSync.instantiate("Tile", {index: 1, x :   20, z :  20, rot : 0});
        var tile = sceneSync.instantiate("Tile", {index: 2, x :   30, z :  20, rot : deg2rad(90)});
        var tile = sceneSync.instantiate("Tile", {index: 2, x :   40, z :  20, rot : deg2rad(90)});

        // var tile = sceneSync.instantiate("Tile", {index: 2, x :  -10, z :  10, rot : 0});
        // var tile = sceneSync.instantiate("Tile", {index: 2, x :    0, z :  10, rot : 0});
        // var tile = sceneSync.instantiate("Tile", {index: 1, x :   10, z :  10, rot : 0});
        // var tile = sceneSync.instantiate("Tile", {index: 1, x :   20, z :  10, rot : 0});
        // var tile = sceneSync.instantiate("Tile", {index: 2, x :   30, z :  10, rot : 0});
        // var tile = sceneSync.instantiate("Tile", {index: 2, x :   40, z :  10, rot : 0});

        // var tile = sceneSync.instantiate("Tile", {index: 3, x :  -10, z :   0, rot : deg2rad(180)});
        // var tile = sceneSync.instantiate("Tile", {index: 4, x :    0, z :   0, rot : deg2rad(90)});
        // var tile = sceneSync.instantiate("Tile", {index: 2, x :   10, z :   0, rot : deg2rad(90)});
        // var tile = sceneSync.instantiate("Tile", {index: 2, x :   20, z :   0, rot : deg2rad(-90)});
        // var tile = sceneSync.instantiate("Tile", {index: 4, x :   30, z :   0, rot : deg2rad(180)});
        // var tile = sceneSync.instantiate("Tile", {index: 3, x :   40, z :   0, rot : deg2rad(180)});

        // var tile = sceneSync.instantiate("Tile", {index: 0, x :  -10, z : -10, rot : 0});
        // var tile = sceneSync.instantiate("Tile", {index: 3, x :    0, z : -10, rot : deg2rad(90)});
        // var tile = sceneSync.instantiate("Tile", {index: 2, x :   10, z : -10, rot : deg2rad(-90)});
        // var tile = sceneSync.instantiate("Tile", {index: 2, x :   20, z : -10, rot : deg2rad(90)});
        // var tile = sceneSync.instantiate("Tile", {index: 3, x :   30, z : -10, rot : deg2rad(-90)});
        // var tile = sceneSync.instantiate("Tile", {index: 0, x :   40, z : -10, rot : 0});





        // var tile = sceneSync.instantiate("Tile", {index: 4, x :    0, z :   0, rot : 0});
        // var tile = sceneSync.instantiate("Tile", {index: 3, x :   10, z :   0, rot : deg2rad(90)});
        // var tile = sceneSync.instantiate("Tile", {index: 3, x :    0, z : -10, rot : 0});

        // var tile = sceneSync.instantiate("Tile", {index: 2, x :  -10, z :   0, rot : deg2rad(180)});
        // var tile = sceneSync.instantiate("Tile", {index: 2, x :  -10, z : -10, rot : deg2rad(180)});
        // var tile = sceneSync.instantiate("Tile", {index: 1, x :  -10, z :  10, rot : deg2rad(180)});
        // var tile = sceneSync.instantiate("Tile", {index: 2, x :    0, z :  10, rot : deg2rad(-90)});
        // var tile = sceneSync.instantiate("Tile", {index: 2, x :   10, z :  10, rot : deg2rad(-90)});

        var tile = sceneSync.instantiate("Tile", {index: 5, x :    0, z :   0, rot : 0}); // avatar
    }
    
    function deg2rad(degrees) {
        return degrees * (Math.PI / 180);
    }

    // Models
    class Model {
        constructor(name, objURL, mtlURL) {
            this.name   = name;
            this.objURL = objURL;
            this.mtlURL = mtlURL;
            this._model = null;
        }
        set model(m) {
            if(m) this._model = m;
        }
        get model() {
            return this._model;
        }
    }

    var modelsURL = "https://cmdrflexo.github.io/A-Frame_Flexo-180620-01/Scene/Grid%20Objects/";
    var models = [
        new Model(
            "Marble Cube", 
            modelsURL + "10m_marble_cube.obj",
            modelsURL + "10m_marble_cube%20-%202K.mtl"
        ),
        new Model(
            "Road Center", 
            // modelsURL + "road-center.obj",
            // modelsURL + "road-center.mtl"
            "road-center.obj",
	        "road-center.mtl"
        ),
        new Model(
            "Road Edge", 
            // modelsURL + "road-edge.obj",
            // modelsURL + "road-edge.mtl"
            "road-edge.obj",
	        "road-edge.mtl"
        ),
        new Model(
            "Large Sidewalk - Straight", 
            modelsURL + "large_sidewalk-straight.obj",
	        modelsURL + "large_sidewalk-straight.mtl"
        ),
        new Model(
            "Large Sidewalk - Corner", 
            // modelsURL + "large_sidewalk-corner.obj",
            // modelsURL + "large_sidewalk-corner.mtl"
            "large_sidewalk-corner.obj",
	        "large_sidewalk-corner.mtl"
        ),
        new Model(
            "Avatar 1", 
            "avatar_1.obj",
	        "avatar_1.mtl"
        )
    ];

</script>
</body>
</html>
